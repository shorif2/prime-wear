import{a as k}from"./utils.CdyNXDGi.js";let t=null,i=null,l=null;async function h(){return!t||!i||Date.now()>i-3e5?l||(l=(async()=>{try{const e=await fetch(k("/auth/token"),{headers:{"X-API-Token":void 0}});return e.ok?(t=(await e.json()).data.token,t&&(i=JSON.parse(atob(t.split(".")[1])).exp*1e3),t):(console.error("Failed to get JWT token:",await e.text()),null)}catch(n){return console.error("Error getting JWT token:",n),null}finally{l=null}})(),l):t}async function w(o,n={},e=2,s=5e3,a=!0){const d=new AbortController,p=setTimeout(()=>d.abort(),s);try{let r=null;a&&(r=await h());const c=new Headers(n.headers||{});r&&c.set("Authorization",`Bearer ${r}`);const f=await fetch(o,{...n,headers:c,signal:d.signal});clearTimeout(p);const u=f.headers.get("X-New-Token");return u&&(t=u,i=JSON.parse(atob(u.split(".")[1])).exp*1e3),f.status===401&&a&&e>0?(t=null,i=null,console.warn("Authentication failed, retrying with new token"),w(o,n,e-1,s,a)):f}catch(r){if(clearTimeout(p),e<=0)throw r;return console.warn(`Retrying fetch to ${o}, ${e} retries left`),await new Promise(c=>setTimeout(c,200*(3-e))),w(o,n,e-1,s,a)}}export{w as f};
